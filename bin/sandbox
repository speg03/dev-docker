#!/bin/sh

: ${SANDBOX_IMAGE:=speg03/sandbox}

: ${SANDBOX_NAME:=sandbox}
: ${SANDBOX_SSH_PORT:=3222}

: ${SANDBOX_HOME:=$HOME/.sandbox}
: ${SANDBOX_USER:=$(whoami)}
: ${SANDBOX_UID:=$(id -u)}
: ${SANDBOX_GID:=$(id -g)}

usage() {
    cat <<EOF
Usage: sandbox [command] [options] [command-in-container]

Commands:
    start  Start sandbox docker container
    run    Run a command in sandbox

Options:
    -p     Publish a port (see "docker help run")
    -h     Print this help
EOF
    exit 1
}

main() {
    [ $# -eq 0 ] && usage
    command=$1
    shift

    while getopts p:h OPTION; do
        case $OPTION in
            p)  publish_options="$publish_options -p $OPTARG" ;;
            h)  usage ;;
            \?) usage ;;
        esac
    done

    shift $((OPTIND - 1))

    case "$command" in
        "start") start_sandbox ;;
        "run")   run_sandbox "$@" ;;
        *)       usage ;;
    esac
}

### Docker Configuration

docker_options=$(cat <<EOF
  -h $SANDBOX_NAME \
  -e SANDBOX_UID=$SANDBOX_UID \
  -e SANDBOX_GID=$SANDBOX_GID \
  -e SANDBOX_USER=$SANDBOX_USER \
  -v $SANDBOX_HOME:/home/$SANDBOX_USER \
  $SANDBOX_IMAGE
EOF
)

start_sandbox() {
    publish_options="$publish_options -p $SANDBOX_SSH_PORT:22"

    docker start $SANDBOX_NAME 2>/dev/null
    if [ $? -ne 0 ]; then
        docker run --detach --name $SANDBOX_NAME \
            $publish_options $docker_options
    fi
}

run_sandbox() {
    docker run --interactive --tty --rm \
        $publish_options $docker_options "cd $(pwd) && $*"
}

main "$@"
